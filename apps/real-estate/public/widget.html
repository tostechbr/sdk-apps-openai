<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real Estate Map</title>

  <!-- Extracted CSS -->
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
  <div class="container">
    <h2>Im√≥veis Dispon√≠veis</h2>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Properties grid -->
    <div id="properties-container" class="loading">
      Carregando im√≥veis...
    </div>
  </div>

  <!-- External modules -->
  <script type="module">
    import { darkMapStyles, mapConfig } from './js/mapConfig.js';
    import { formatPrice, formatPriceShort, getImageTag } from './js/utils.js';

    // Global variables
    let map;
    let markers = {};
    let infoWindows = {};

    /**
     * Initialize Google Maps
     */
    function initMap() {
      try {
        const properties = window.openai?.toolOutput?.properties ?? [];

        // Create map with dark theme
        map = new google.maps.Map(document.getElementById('map'), {
          center: mapConfig.defaultCenter,
          zoom: mapConfig.defaultZoom,
          mapTypeId: mapConfig.mapType,
          styles: darkMapStyles
        });

        // Add markers and render cards
        addMarkers(properties);
        renderProperties(properties);
      } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('properties-container').innerHTML =
          '<div class="no-properties">Erro ao carregar o mapa. Tente novamente.</div>';
      }
    }

    /**
     * Add markers to map
     * @param {Array} properties - Array of property objects
     */
    function addMarkers(properties) {
      // Clear existing markers
      Object.values(markers).forEach(marker => marker.setMap(null));
      Object.values(infoWindows).forEach(infoWindow => infoWindow.close());
      markers = {};
      infoWindows = {};

      if (!Array.isArray(properties) || properties.length === 0) {
        console.warn('No properties to display');
        return;
      }

      const bounds = new google.maps.LatLngBounds();

      properties.forEach(property => {
        try {
          // Validate coordinates
          if (!property.lat || !property.lng) {
            console.error('Invalid property coordinates:', property);
            return;
          }

          // Create marker with price label
          const marker = new google.maps.Marker({
            position: { lat: property.lat, lng: property.lng },
            map: map,
            title: property.title,
            label: {
              text: formatPriceShort(property.price),
              color: 'white',
              fontSize: '14px',
              fontWeight: 'bold'
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 0,
              fillColor: '#dc2626',
              fillOpacity: 1,
              strokeColor: 'white',
              strokeWeight: 2
            }
          });

          // Create info window
          const infoWindow = createInfoWindow(property);

          // Add click listener
          marker.addListener('click', () => {
            Object.values(infoWindows).forEach(iw => iw.close());
            infoWindow.open(map, marker);
          });

          markers[property.id] = marker;
          infoWindows[property.id] = infoWindow;
          bounds.extend({ lat: property.lat, lng: property.lng });
        } catch (error) {
          console.error('Error creating marker for property:', property, error);
        }
      });

      // Fit map to show all markers
      if (properties.length > 0) {
        map.fitBounds(bounds);
        if (properties.length === 1) {
          map.setZoom(mapConfig.detailZoom);
        }
      }
    }

    /**
     * Create info window for property
     * @param {Object} property - Property object
     * @returns {google.maps.InfoWindow} Info window instance
     */
    function createInfoWindow(property) {
      const imageHtml = getImageTag(property, 'infoWindow');

      const content = `
        <div class="info-window">
          ${imageHtml}
          <div class="info-window-title">${property.title}</div>
          <div class="info-window-price">${formatPrice(property.price)}</div>
          <div class="info-window-details">
            ${property.bedrooms} quartos ‚Ä¢ ${property.bathrooms} banheiros ‚Ä¢ ${property.area}m¬≤
          </div>
        </div>
      `;

      return new google.maps.InfoWindow({ content });
    }

    /**
     * Render property cards
     * @param {Array} properties - Array of property objects
     */
    function renderProperties(properties) {
      const container = document.getElementById('properties-container');

      if (!Array.isArray(properties) || properties.length === 0) {
        container.className = 'no-properties';
        container.innerHTML = 'Nenhum im√≥vel encontrado.';
        return;
      }

      container.className = 'properties-grid';
      container.innerHTML = properties.map(property => {
        const imageHtml = getImageTag(property, 'card');

        return `
          <div class="property-card" data-id="${property.id}">
            ${imageHtml}
            <div class="property-content">
              <h3 class="property-title">${property.title}</h3>
              <div class="property-price">${formatPrice(property.price)}</div>
              <p class="property-address">${property.address}</p>
              <div class="property-details">
                <div class="property-detail">üõèÔ∏è ${property.bedrooms} quartos</div>
                <div class="property-detail">üöø ${property.bathrooms} banheiros</div>
                <div class="property-detail">üìè ${property.area}m¬≤</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      container.querySelectorAll('.property-card').forEach(card => {
        card.addEventListener('click', () => handleCardClick(card, properties));
      });
    }

    /**
     * Handle card click
     * @param {HTMLElement} card - Card element
     * @param {Array} properties - Array of properties
     */
    function handleCardClick(card, properties) {
      try {
        const propertyId = card.dataset.id;
        const property = properties.find(p => p.id === propertyId);
        const marker = markers[propertyId];
        const infoWindow = infoWindows[propertyId];

        if (!property || !marker || !infoWindow) {
          console.warn('Property, marker, or info window not found for ID:', propertyId);
          return;
        }

        // Close all info windows
        Object.values(infoWindows).forEach(iw => iw.close());

        // Center map and open info window
        map.panTo({ lat: property.lat, lng: property.lng });
        map.setZoom(mapConfig.detailZoom);
        infoWindow.open(map, marker);
      } catch (error) {
        console.error('Error handling card click:', error);
      }
    }

    /**
     * Handle global updates from window.openai
     * @param {Event} event - Custom event
     */
    function handleSetGlobals(event) {
      try {
        const globals = event.detail?.globals;
        if (globals?.toolOutput?.properties) {
          const properties = globals.toolOutput.properties;
          addMarkers(properties);
          renderProperties(properties);
        }
      } catch (error) {
        console.error('Error handling set globals:', error);
      }
    }

    // Listen for global updates
    window.addEventListener('openai:set_globals', handleSetGlobals, {
      passive: true
    });

    // Initialize when properties are available
    if (window.openai?.toolOutput?.properties) {
      if (typeof google !== 'undefined') {
        initMap();
      }
    }

    // Expose initMap globally for Google Maps callback
    window.initMap = initMap;
  </script>

  <!-- Google Maps JavaScript API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKaT7hbQoYKh1E6PLqzou_4fYgM0-7Jns&callback=initMap"
    async defer></script>
</body>

</html>