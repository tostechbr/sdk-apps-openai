<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real Estate Map</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --text-primary: #0b0b0f;
      --text-secondary: #6c768a;
      --bg-main: #f6f8fb;
      --bg-card: #ffffff;
      --border-color: #e5e7eb;
      --price-color: #dc2626;
      --shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
    }

    body {
      padding: 16px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h2 {
      margin: 0 0 16px;
      font-size: 1.5rem;
      font-weight: 700;
    }

    /* Map Container */
    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    /* Property Cards */
    .properties-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .property-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .property-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      border-color: var(--primary-color);
    }

    .property-icon {
      font-size: 3rem;
      margin-bottom: 8px;
      display: block;
    }

    .property-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--text-primary);
    }

    .property-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--price-color);
      margin: 0 0 12px;
    }

    .property-address {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0 0 12px;
      line-height: 1.4;
    }

    .property-details {
      display: flex;
      gap: 16px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .property-detail {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .no-properties {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Custom Leaflet marker styles */
    .price-marker {
      background: var(--price-color);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.875rem;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
      border: 2px solid white;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üè† Im√≥veis Dispon√≠veis</h2>
    
    <!-- Map container -->
    <div id="map"></div>
    
    <!-- Properties grid -->
    <div id="properties-container" class="loading">
      Carregando im√≥veis...
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script type="module">
    // Get properties from window.openai
    let properties = window.openai?.toolOutput?.properties ?? [];
    
    // Initialize map centered on S√£o Paulo
    const map = L.map('map').setView([-23.5505, -46.6333], 12);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    // Custom icon for property markers
    function createPriceMarker(price) {
      const priceFormatted = `R$ ${Math.round(price / 1000)}k`;
      return L.divIcon({
        className: 'custom-marker',
        html: `<div class="price-marker">${priceFormatted}</div>`,
        iconSize: [60, 30],
        iconAnchor: [30, 30]
      });
    }

    // Store markers for later access
    const markers = {};

    // Add markers to map
    properties.forEach(property => {
      const marker = L.marker([property.lat, property.lng], {
        icon: createPriceMarker(property.price)
      }).addTo(map);

      // Popup with property info
      marker.bindPopup(`
        <div style="text-align: center;">
          <div style="font-size: 2rem;">${property.image}</div>
          <strong>${property.title}</strong><br/>
          <span style="color: #dc2626; font-weight: 700;">
            R$ ${property.price.toLocaleString('pt-BR')}
          </span>
        </div>
      `);

      markers[property.id] = marker;
    });

    // Fit map to show all markers
    if (properties.length > 0) {
      const bounds = L.latLngBounds(properties.map(p => [p.lat, p.lng]));
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    // Render property cards
    function renderProperties() {
      const container = document.getElementById('properties-container');
      
      if (properties.length === 0) {
        container.className = 'no-properties';
        container.innerHTML = 'Nenhum im√≥vel encontrado.';
        return;
      }

      container.className = 'properties-grid';
      container.innerHTML = properties.map(property => `
        <div class="property-card" data-id="${property.id}">
          <span class="property-icon">${property.image}</span>
          <h3 class="property-title">${property.title}</h3>
          <div class="property-price">R$ ${property.price.toLocaleString('pt-BR')}</div>
          <p class="property-address">${property.address}</p>
          <div class="property-details">
            <div class="property-detail">üõèÔ∏è ${property.bedrooms} quartos</div>
            <div class="property-detail">üöø ${property.bathrooms} banheiros</div>
            <div class="property-detail">üìè ${property.area}m¬≤</div>
          </div>
        </div>
      `).join('');

      // Add click handlers to cards
      container.querySelectorAll('.property-card').forEach(card => {
        card.addEventListener('click', () => {
          const propertyId = card.dataset.id;
          const property = properties.find(p => p.id === propertyId);
          const marker = markers[propertyId];
          
          if (property && marker) {
            // Center map on property and open popup
            map.setView([property.lat, property.lng], 15);
            marker.openPopup();
          }
        });
      });
    }

    // Listen for global updates from window.openai
    const handleSetGlobals = (event) => {
      const globals = event.detail?.globals;
      if (globals?.toolOutput?.properties) {
        properties = globals.toolOutput.properties;
        
        // Clear existing markers
        Object.values(markers).forEach(marker => marker.remove());
        Object.keys(markers).forEach(key => delete markers[key]);
        
        // Re-add markers
        properties.forEach(property => {
          const marker = L.marker([property.lat, property.lng], {
            icon: createPriceMarker(property.price)
          }).addTo(map);

          marker.bindPopup(`
            <div style="text-align: center;">
              <div style="font-size: 2rem;">${property.image}</div>
              <strong>${property.title}</strong><br/>
              <span style="color: #dc2626; font-weight: 700;">
                R$ ${property.price.toLocaleString('pt-BR')}
              </span>
            </div>
          `);

          markers[property.id] = marker;
        });

        // Fit bounds
        if (properties.length > 0) {
          const bounds = L.latLngBounds(properties.map(p => [p.lat, p.lng]));
          map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        renderProperties();
      }
    };

    window.addEventListener('openai:set_globals', handleSetGlobals, {
      passive: true
    });

    // Initial render
    renderProperties();
  </script>
</body>
</html>
