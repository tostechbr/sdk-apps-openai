<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real Estate Map</title>

  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --text-primary: #f5f5f5;
      --text-secondary: #b0b0b0;
      --bg-main: #212121;
      --bg-card: #2a2a2a;
      --border-color: #3a3a3a;
      --price-color: #ef4444;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    /* Info Window Styles - Force Dark Theme */
    .gm-style-iw {
      background-color: #2a2a2a !important;
      color: #f5f5f5 !important;
      padding: 0 !important;
      border-radius: 8px !important;
    }

    .gm-style-iw-c {
      background-color: #2a2a2a !important;
      padding: 0 !important;
    }

    .gm-style-iw-d {
      background-color: #2a2a2a !important;
      color: #f5f5f5 !important;
      overflow: hidden !important;
    }

    /* Remove the default tail arrow background if needed, or color it */
    .gm-style-iw-tc::after {
      background: #2a2a2a !important;
    }

    /* Custom content styles */
    .info-window {
      background: #2a2a2a;
      color: #f5f5f5;
      padding: 12px;
      min-width: 200px;
    }

    .info-window h3 {
      font-size: 16px;
      margin: 0 0 8px 0;
      color: #fff;
    }

    .info-window p {
      margin: 4px 0;
      color: #bbb;
    }

    .info-window .price {
      color: var(--price-color);
      font-weight: bold;
      font-size: 18px;
      margin-top: 8px;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
    }

    body {
      padding: 16px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h2 {
      margin: 0 0 16px;
      font-size: 1.5rem;
      font-weight: 700;
    }

    /* Map Container */
    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }

    /* Property Cards */
    .properties-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .property-card {
      background: var(--bg-card);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
    }

    .property-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
      border-color: var(--primary-color);
    }

    .property-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #1a1a1a;
    }

    .property-content {
      padding: 16px;
    }

    .property-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--text-primary);
    }

    .property-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--price-color);
      margin: 0 0 12px;
    }

    .property-address {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0 0 12px;
      line-height: 1.4;
    }

    .property-details {
      display: flex;
      gap: 16px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .property-detail {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .no-properties {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Custom Google Maps marker styles */
    .price-marker {
      background: var(--price-color);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.875rem;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
      border: 2px solid white;
      position: relative;
    }

    .price-marker::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid var(--price-color);
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Im√≥veis Dispon√≠veis</h2>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Properties grid -->
    <div id="properties-container" class="loading">
      Carregando im√≥veis...
    </div>
  </div>

  <script>
    // Global variable to store map reference
    let map;
    let markers = {};
    let infoWindows = {};

    // Initialize Google Maps
    function initMap() {
      // Get properties from window.openai
      let properties = window.openai?.toolOutput?.properties ?? [];

      // Create map centered on S√£o Paulo
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -23.5505, lng: -46.6333 },
        zoom: 12,
        mapTypeId: 'roadmap',
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      // Add markers and setup interactivity
      addMarkers(properties);
      renderProperties(properties);
    }

    function addMarkers(properties) {
      // Clear existing markers
      Object.values(markers).forEach(marker => marker.setMap(null));
      Object.values(infoWindows).forEach(infoWindow => infoWindow.close());
      markers = {};
      infoWindows = {};

      if (properties.length === 0) return;

      const bounds = new google.maps.LatLngBounds();

      properties.forEach(property => {
        // Create custom marker with price
        const priceFormatted = `R$ ${Math.round(property.price / 1000)}k`;

        const marker = new google.maps.Marker({
          position: { lat: property.lat, lng: property.lng },
          map: map,
          title: property.title,
          label: {
            text: priceFormatted,
            color: 'white',
            fontSize: '14px',
            fontWeight: 'bold'
          },
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 0,
            fillColor: '#dc2626',
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 2
          }
        });

        // Create info window with property details
        const imageTag = property.image.startsWith('http') || property.image.startsWith('/')
          ? `<img src="${property.image}" style="width: 150px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" onerror="this.style.display='none'" />`
          : `<div style="font-size: 3rem; margin-bottom: 8px;">${property.image}</div>`;

        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="text-align: center; padding: 8px; max-width: 200px;">
              ${imageTag}
              <div><strong>${property.title}</strong></div>
              <div style="color: #dc2626; font-weight: 700; font-size: 1.125rem; margin-top: 4px;">
                R$ ${property.price.toLocaleString('pt-BR')}
              </div>
              <div style="color: #6c768a; font-size: 0.875rem; margin-top: 4px;">
                ${property.bedrooms} quartos ‚Ä¢ ${property.bathrooms} banheiros ‚Ä¢ ${property.area}m¬≤
              </div>
            </div>
          `
        });

        marker.addListener('click', () => {
          // Close all other info windows
          Object.values(infoWindows).forEach(iw => iw.close());
          infoWindow.open(map, marker);
        });

        markers[property.id] = marker;
        infoWindows[property.id] = infoWindow;
        bounds.extend({ lat: property.lat, lng: property.lng });
      });

      // Fit map to show all markers
      if (properties.length > 0) {
        map.fitBounds(bounds);
        if (properties.length === 1) {
          map.setZoom(15);
        }
      }
    }

    // Render property cards
    function renderProperties(properties) {
      const container = document.getElementById('properties-container');

      if (properties.length === 0) {
        container.className = 'no-properties';
        container.innerHTML = 'Nenhum im√≥vel encontrado.';
        return;
      }

      container.className = 'properties-grid';
      container.innerHTML = properties.map(property => {
        const imageTag = property.image.startsWith('http') || property.image.startsWith('/')
          ? `<img src="${property.image}" alt="${property.title}" class="property-image" onerror="this.style.display='none'" />`
          : `<div class="property-image" style="display: flex; align-items: center; justify-content: center; font-size: 4rem;">${property.image}</div>`;

        return `
          <div class="property-card" data-id="${property.id}">
            ${imageTag}
            <div class="property-content">
              <h3 class="property-title">${property.title}</h3>
              <div class="property-price">R$ ${property.price.toLocaleString('pt-BR')}</div>
              <p class="property-address">${property.address}</p>
              <div class="property-details">
                <div class="property-detail">üõèÔ∏è ${property.bedrooms} quartos</div>
                <div class="property-detail">üöø ${property.bathrooms} banheiros</div>
                <div class="property-detail">üìè ${property.area}m¬≤</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers to cards
      container.querySelectorAll('.property-card').forEach(card => {
        card.addEventListener('click', () => {
          const propertyId = card.dataset.id;
          const property = properties.find(p => p.id === propertyId);
          const marker = markers[propertyId];
          const infoWindow = infoWindows[propertyId];

          if (property && marker && infoWindow) {
            // Close all info windows
            Object.values(infoWindows).forEach(iw => iw.close());
            // Center map on property and open info window
            map.panTo({ lat: property.lat, lng: property.lng });
            map.setZoom(15);
            infoWindow.open(map, marker);
          }
        });
      });
    }

    // Listen for global updates from window.openai
    const handleSetGlobals = (event) => {
      const globals = event.detail?.globals;
      if (globals?.toolOutput?.properties) {
        const properties = globals.toolOutput.properties;
        addMarkers(properties);
        renderProperties(properties);
      }
    };

    window.addEventListener('openai:set_globals', handleSetGlobals, {
      passive: true
    });

    // Initialize when properties are available
    if (window.openai?.toolOutput?.properties) {
      // Wait for Google Maps to load
      if (typeof google !== 'undefined') {
        initMap();
      }
    }
  </script>

  <!-- Google Maps JavaScript API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKaT7hbQoYKh1E6PLqzou_4fYgM0-7Jns&callback=initMap"
    async defer></script>
</body>

</html>